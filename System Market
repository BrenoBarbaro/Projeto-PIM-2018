#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <conio.h>
#include <windows.h>

void gotoxy(int x, int y){
     SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE),(COORD){x-1,y-1});
}

typedef struct Produtos
{
	char codProduto[5];
	char nomeProduto[12];
	double valorProduto;
	struct Produtos *proximo;
} Produtos;

typedef struct ListaCliente
{
	char codProduto[5];
	char nomeProduto[12];
	double valorProduto;
	struct ListaCliente *proximo;
} ListaCliente;

typedef struct usuarios
{
	char usuarioCadastrado[12];
	char senhaCadastrada[8];
}Login;

Produtos *inicio = NULL;
ListaCliente *cliente = NULL;
Login *ListaUsers = NULL;

void menu();
void lerParaStruct();
void DesingCaixa();
void iniciaCompra();
void ExibeProdutos();
void administrativeSystem();
void saldoDia();
void produtosVendidos();
void adicionarProdutos();
void ExibeProdutosAdmin();
void menuFuncionario();
void cadastraUsuario();
void MostraLogin();
void telaLogin();
void autorizaLogin();
void autorizaCaixa();
void autorizaAdministrativo();
void autorizaSeguranca();
void PesquisaFuncionario();
void listarFuncionarios();
void sair();
void retornar();

int main()
{
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		cadastraUsuario();
	}else{
		telaLogin();
	}
	fclose(fp);
	
	return 0;
}


// ----------------------- Menu -----------------------

void menu()
{
	char c;
	
	do{
	    system("cls");
	    printf("**********************************************************");
	    printf("\n*                    NewHorizon Market                   *");
	    printf("\n*                                                        *");
	    printf("\n*      1 - Sistema de Caixa                              *");
	    printf("\n*      2 - Sistema Administrativo                        *");
	    printf("\n*      3 - Sistema de Seguranca                          *");
	    printf("\n*                                                        *");
	    printf("\n*      5 - Sair                                          *");
	    printf("\n*                                                        *");
	    printf("\n**********************************************************");
	    printf("\n*      Opcao:                                            *");
	    printf("\n**********************************************************");
	    gotoxy(15,10); c = getch();
	    switch(c)
		{
			case '1': autorizaCaixa(); break;
			
			case '2': autorizaAdministrativo(); break;
			
			case '3': autorizaSeguranca(); break;
			
			case '5': sair(); break;
			
			default: gotoxy(15,10); printf("Opcao Invalida.  (Press enter to continue)"); getch(); break;
		}
	}while(c != '5');
}

// ------------------- Ler para Struct -------------------
void lerParaStruct()
{
	Produtos *aux;
	FILE *fp;
	fp = fopen("Produtos.dat","rb");
	if(fp == NULL)
	{
		while(!feof(fp)){
			if((fread(&aux,sizeof(Produtos),1,fp))==1){
				Produtos *temp = (Produtos*) malloc(sizeof(Produtos));
				strcpy(temp->codProduto,aux->codProduto);
				strcpy(temp->nomeProduto,aux->nomeProduto);
				temp->valorProduto = aux->valorProduto;
				temp->proximo = inicio;
				inicio = temp;
			}
		}
	}else{
		while(!feof(fp)){
			if((fread(&aux,sizeof(Produtos),1,fp))==1){
				Produtos *temp = (Produtos*) malloc(sizeof(Produtos));
				strcpy(temp->codProduto,aux->codProduto);
				strcpy(temp->nomeProduto,aux->nomeProduto);
				temp->valorProduto = aux->valorProduto;
				temp->proximo = inicio;
				inicio = temp;
			}
		}
	}
	fclose(fp);
	
	Produtos *no = inicio;
	while(no!=NULL)
	{
		printf("\n\nCod: %s",no->codProduto);
		printf("\nNome: %s",no->nomeProduto);
		printf("\nValor: %0.2lf", no->valorProduto);
		no = no->proximo;
	}
	getch();
}

// --------------------- Menu Caixa --------------------

void DesingCaixa()
{
    char op1;
    system("cls");
    printf("******************************************************");
    printf("\n*                Sistema de Mercado                  *");
    printf("\n*                                                    *");
    printf("\n*      1 - Iniciar Compras                           *");
    printf("\n*                                                    *");
    printf("\n*                                                    *");
    printf("\n*      5 - Sair                                      *");
    printf("\n*                                                    *");
    printf("\n******************************************************");
    printf("\n*      Opcao:                                        *");
    printf("\n******************************************************\n");
    op1 = getch();
    switch(op1)
    {
        case '1': iniciaCompra(); break;
        
        case '5': retornar(); break;
        
        default: printf("\n\nTecla invalida!\n"); break;
    }
}

void ExibeProdutos()
{
    Produtos inicio;
	FILE *fp;
	
    system("CLS");
    if((fp = fopen("Produtos.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo!\n");
	}else{
        int y=5;
        printf("***********************************************************************\n");
        printf("                                                                       \n");
        printf("    Codigo:              Nome:                       Valor:            \n");
        printf("                                                                       \n");
        fp == fopen("Produtos.dat","rb");
	    if(fp == NULL)
		{
			printf("\nErro na abertura do arquivo.\n\n");
			exit(1);
		}else{
		    while(fread(&inicio,sizeof(Produtos),1,fp)==1)
	        {
	            gotoxy(5,y);printf("%s",inicio.codProduto);
	            gotoxy(26,y);printf("%s",inicio.nomeProduto);
	            gotoxy(54,y);printf("%0.2lf",inicio.valorProduto);
	            y++;
	        }
		}
        printf("\n                                                                     ");
        printf("\n***********************************************************************\n\n");
        printf("(Press enter to continue)");
        fclose(fp);
	}
}

void iniciaCompra()
{
	ExibeProdutos();
	
	char codigo[5],c;
	FILE *fp;
	
	if((fp = fopen("Produtos.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}else{
		do{
			fflush(stdin);
			printf("Codigo: ");
			gets(codigo);
			fflush(stdin);
			codigo[strcspn(codigo,"\r\n")] = '\0';
			while(fread(&inicio,sizeof(Login),1,fp)==1)
			{
				if(strcmp(inicio.codProduto,codigo)==0)
				{
					strcpy(cliente.codProduto,inicio.codProduto);
					strcpy(cliente.nomeProduto,inicio.nomeProduto);
					cliente.valorProduto = inicio.valorProduto;
				}
			}
			
			c = getch();
		}while((c != 's') || (c != 'S'));
	}
}

// ----------------- Menu Administrativo -----------------

void administrativeSystem()
{
    char op2;
    do{
	    system("CLS");
	    printf("**********************************************************");
	    printf("\n*               Sistema de Administrativo                *");
	    printf("\n*                                                        *");
	    printf("\n*   1 - Saldo de Vendas do Dia                           *");
	    printf("\n*   2 - Produtos Vendidos                                *");
	    printf("\n*   3 - Adicionar Produtos                               *");
	    printf("\n*   4 - Exibir Produtos                                  *");
	    printf("\n*   5 - Ler para Struct                                  *");
		printf("\n*                                                        *");
	    printf("\n*   9 - Sair                                             *");
	    printf("\n*                                                        *");
	    printf("\n**********************************************************");
	    printf("\n*   Opcao:                                               *");
	    printf("\n**********************************************************");
	    gotoxy(12,13); op2 = getch();
	    switch(op2)
	    {
	        case '1': saldoDia(); break;
	
	        case '2': produtosVendidos(); break;
	
	        case '3': adicionarProdutos();    break;
	
	        case '4': ExibeProdutosAdmin();  getch(); break;
	        
	        case '5': lerParaStruct();	break;
	        
	        case '9': retornar(); break;
	        
	        default: printf("\n\nOpcao invalida.  (Press enter to continue)"); getch(); break;
	    }
	}while(op2 != '5');
}

void saldoDia()
{
    system("CLS");
    printf("*********************************************************************");
    printf("\n*                        Saldos do Dia                              *");
    printf("\n*                                                                   *");
    printf("\n*   N. Venda:        Quantidade de Produtos:        Valor:          *");
    printf("\n*                                                                   *");
    printf("\n*        1                    85                    R$ 458.78       *");
    printf("\n*        2                     7                    R$ 15.82        *");
    printf("\n*        3                    15                    R$ 31.02        *");
    printf("\n*        4                     5                    R$ 10.98        *");
    printf("\n*        5                    19                    R$ 19.19        *");
    printf("\n*        6                    45                    R$ 65.75        *");
    printf("\n*        7                   126                    R$ 726.15       *");
    printf("\n*        8                    72                    R$ 389.17       *");
    printf("\n*        9                    23                    R$ 25.12        *");
    printf("\n*        10                   31                    R$ 43.68        *");
    printf("\n*        11                   14                    R$ 20.98        *");
    printf("\n*                                                                   *");
    printf("\n*********************************************************************\n");
    system("PAUSE");
}

void produtosVendidos()
{
    system("CLS");
    printf("*********************************************************************");
    printf("\n*                       Produtos Vendidos                          *");
    printf("\n*                                                                  *");
    printf("\n*      Nome do Produtos:                        Quantidade:        *");
    printf("\n*                                                                  *");
    printf("\n*      1- Arroz                                                    *");
    printf("\n*      2- Feijao                                 R$ 15.82          *");
    printf("\n*      3- Macarrao                               R$ 31.02          *");
    printf("\n*      4- Molho de Tomate                        R$ 10.98          *");
    printf("\n*      5- Sorvete                                R$ 19.19          *");
    printf("\n*      6- Bolacha                                R$ 65.75          *");
    printf("\n*      7- Sabao em Po                            R$ 726.15         *");
    printf("\n*      8- Pao frances                            R$ 389.17         *");
    printf("\n*      9- batata                                 R$ 25.12          *");
    printf("\n*     10- Abobrinha                              R$ 43.68          *");
    printf("\n*     11- Tomate                                 R$ 20.98          *");
    printf("\n*                                                                  *");
    printf("\n********************************************************************\n");
    system("PAUSE");
}

void adicionarProdutos()
{
    Produtos inicio;
	FILE *fp;
	
    if((fp = fopen("produtos.dat","ab"))==NULL)
    {
        printf("Problema na abertura do arquivo.\n\n");
		exit(1);
    }
    else
    {
		system("CLS");
        printf("*********************************************************************");
        printf("\n*                                                                   *");
        printf("\n*                       Adicionar Produtos                          *");
        printf("\n*                                                                   *");
        printf("\n*                                                                   *");
        printf("\n*     Codigo do Produto:                                            *");
        printf("\n*                                                                   *");
        printf("\n*     Nome do Produto:                                              *");
        printf("\n*                                                                   *");
        printf("\n*     Valor do produto:                                             *");
        printf("\n*                                                                   *");
        printf("\n*                                                                   *");
        printf("\n*                                                                   *");
        printf("\n*                                                                   *");
        printf("\n*********************************************************************\n");
        fflush(stdin);
        gotoxy(26,6);gets(inicio.codProduto);
        fflush(stdin);
        gotoxy(24,8);gets(inicio.nomeProduto);
        gotoxy(25,10);printf("R$");
        fflush(stdin);
        gotoxy(28,10);scanf("%lf",&inicio.valorProduto);
        gotoxy(7,13);printf("Produto adicionado com sucesso!");
        
        fwrite(&inicio,sizeof(Produtos),1,fp);
		printf("\n\n\n\n(Press enter to continue");
	}
	fclose(fp);
	getch();
}

void ExibeProdutosAdmin()
{
    Produtos inicio;
	FILE *fp;
	
    system("CLS");
    if((fp = fopen("Produtos.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo!\n");
	}else{
        int y=5;
        printf("***********************************************************************\n");
        printf("                                                                       \n");
        printf("    Codigo:              Nome:                       Valor:            \n");
        printf("                                                                       \n");
        fp == fopen("Produtos.dat","rb");
	    if(fp == NULL)
		{
			printf("\nErro na abertura do arquivo.\n\n");
			exit(1);
		}else{
		    while(fread(&inicio,sizeof(Produtos),1,fp)==1)
	        {
	            gotoxy(5,y);printf("%s",inicio.codProduto);
	            gotoxy(26,y);printf("%s",inicio.nomeProduto);
	            gotoxy(54,y);printf("%0.2lf",inicio.valorProduto);
	            y++;
	        }
		}
        printf("\n                                                                     ");
        printf("\n***********************************************************************\n\n");
        printf("(Press enter to continue)");
        fclose(fp);
    }
}

// ------------------- Funcionarios -------------------

void menuFuncionario()
{
	
    char op;

    do
    {
        fflush(stdin);
        system("cls");
        printf("******************************************************");
        printf("\n*                 NewHorizon Market                  *");
        printf("\n*                                                    *");
        printf("\n*      1 - Cadastrar Funcionario                     *");
        printf("\n*      2 - Listar Funcionarios                       *");
        printf("\n*      3 - Pesquisar Funcionario                     *");
        printf("\n*                                                    *");
        printf("\n*                                                    *");
        printf("\n*      5 - Sair                                      *");
        printf("\n*                                                    *");
        printf("\n******************************************************");
        printf("\n*      Opcao:                                        *");
        printf("\n******************************************************");
        gotoxy(15,10); op = getch();
        switch(op)
        {

            case '1': cadastraUsuario(); break;

            case '2': autorizaLogin();

            case '3': PesquisaFuncionario(); break;

  	    	case '5': retornar(); break;

            default: gotoxy(15,10); printf("Opcao Invalida\n\nPressione Enter para continuar!"); break;
        }
    }while(op != 5);
}

void cadastraUsuario()
{
	Login cUsers;
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","ab"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
		exit(1);
	}
	
	printf("---> Cadastro de usuarios <---\n\n");
	fflush(stdin);
	printf("Usuario: ");
	gets(cUsers.usuarioCadastrado);
	fflush(stdin);
	printf("Senha: ");
	gets(cUsers.senhaCadastrada);
	fflush(stdin);
	
	fwrite(&cUsers,sizeof(Login),1,fp);
	fclose(fp);
	menu();
	
}

void MostraLogin()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
    int i=0,x=3;
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{
	}
    fclose(fp);
    do
	{
		system("CLS");
		printf("---> Login <---\n\n");
		fflush(stdin);
		printf("Usuario: ");
		fgets(usuario,sizeof(usuario),stdin);
		fflush(stdin);
		printf("Senha: ");
		fgets(senha,sizeof(senha),stdin);
		fflush(stdin);
		
		usuario[strcspn(usuario,"\r\n")] = '\0';
		senha[strcspn(senha,"\r\n")] = '\0';
		
		if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
		{
			menu();
		}else{
			printf("\n\nUsuario ou Senha Invalido!\n\n");
		}
		printf("Restam %d tentativas\t\tPressione qualquer tecla para continuar!",x--);
		getch();
		i++;
	}while(i<=3);
	exit(1);
}

void telaLogin()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{

	}
    fclose(fp);
	system("CLS");
	printf("---> Login <---\n\n");
	fflush(stdin);
	printf("Usuario: ");
	fgets(usuario,sizeof(usuario),stdin);
	fflush(stdin);
	printf("Senha: ");
	fgets(senha,sizeof(senha),stdin);
	fflush(stdin);
	
	usuario[strcspn(usuario,"\r\n")] = '\0';
	senha[strcspn(senha,"\r\n")] = '\0';
	
	if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
	{
		menu();
	}else{
		printf("\n\nUsuario ou Senha Invalido!\n\n");
	}
	getch();
	exit(1);
}

void autorizaLogin()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{

	}
    fclose(fp);
   
		system("CLS");
		printf("---> Login <---\n\n");
		fflush(stdin);
		printf("Usuario: ");
		fgets(usuario,sizeof(usuario),stdin);
		fflush(stdin);
		printf("Senha: ");
		fgets(senha,sizeof(senha),stdin);
		
		usuario[strcspn(usuario,"\r\n")] = '\0';
		senha[strcspn(senha,"\r\n")] = '\0';
		
		if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
		{
			listarFuncionarios();
		}else{
			menu();
		}
		getch();	
}

void autorizaCaixa()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{

	}
    fclose(fp);
   
	system("CLS");
	printf("---> Login <---\n\n");
	fflush(stdin);
	printf("Usuario: ");
	fgets(usuario,sizeof(usuario),stdin);
	fflush(stdin);
	printf("Senha: ");
	fgets(senha,sizeof(senha),stdin);
	
	usuario[strcspn(usuario,"\r\n")] = '\0';
	senha[strcspn(senha,"\r\n")] = '\0';
	
	if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
	{
		DesingCaixa();
	}else{
		menu();
	}
	getch();	
}

void autorizaAdministrativo()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{

	}
    fclose(fp);
   
	system("CLS");
	printf("---> Login <---\n\n");
	fflush(stdin);
	printf("Usuario: ");
	fgets(usuario,sizeof(usuario),stdin);
	fflush(stdin);
	printf("Senha: ");
	fgets(senha,sizeof(senha),stdin);
	
	usuario[strcspn(usuario,"\r\n")] = '\0';
	senha[strcspn(senha,"\r\n")] = '\0';
	
	if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
	{
		administrativeSystem();
	}else{
		menu();
	}
	getch();
}

void autorizaSeguranca()
{
	Login cUsers;
	char usuario[12];
    char senha[8];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo.\n\n");
	}
	printf("\n\n");
	while(fread(&cUsers,sizeof(Login),1,fp)==1)
	{

	}
    fclose(fp);
   
	system("CLS");
	printf("---> Login <---\n\n");
	fflush(stdin);
	printf("Usuario: ");
	fgets(usuario,sizeof(usuario),stdin);
	fflush(stdin);
	printf("Senha: ");
	fgets(senha,sizeof(senha),stdin);
	
	usuario[strcspn(usuario,"\r\n")] = '\0';
	senha[strcspn(senha,"\r\n")] = '\0';
	
	if((strcmp(cUsers.usuarioCadastrado,usuario)==0) && (strcmp(cUsers.usuarioCadastrado,usuario)==0))
	{
		menuFuncionario();
	}else{
		menu();
	}
	getch();
}

void PesquisaFuncionario()
{
	Login cUsers;
	char usuario[12];
	
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo!\n");
	}else{
		system("CLS");
		printf("---> Pesquisa Funcionario <---\n\n");
		fflush(stdin);
		printf("Usuario: ");
		gets(usuario);
		while(fread(&cUsers,sizeof(Login),1,fp)==1)
		{
			if(strcmp(cUsers.usuarioCadastrado,usuario)==0)
			{
				printf("---------------------------------\n");
				printf("Usuario: %s\nSenha: %s\n",cUsers.usuarioCadastrado,cUsers.senhaCadastrada);
				printf("---------------------------------\n\n");
			}
		}
	}
	getch();
}

void listarFuncionarios()
{
	Login cUsers;
	FILE *fp;
	
	if((fp = fopen("Usuarios.dat","rb"))==NULL)
	{
		printf("Problema na abertura do arquivo!\n");
	}else{
		while(fread(&cUsers,sizeof(Login),1,fp)==1)
		{
			printf("---------------------------------\n");
			printf("Usuario: %s\nSenha: %s\n",cUsers.usuarioCadastrado,cUsers.senhaCadastrada);
			printf("---------------------------------\n\n");
		}
	}
	printf("\n\nPressione qualquer tecla para continuar.");
	getch();
	menu();
}

// ------------------- SaÃ­da -------------------

void retornar()
{
	char c;
	system("CLS");
	printf("*************************************************");
    printf("\n*               Retorno / Saida                 *");
    printf("\n*                                               *");
    printf("\n*      1 - Retornar Menu principal              *");
    printf("\n*      2 - Fechar software                      *");
    printf("\n*                                               *");
    printf("\n*************************************************");
    c = getch();
    switch(c)
    {
		case '1': MostraLogin(); break;
		
		case '2': sair(); break;
		
		default: printf("Opcao invalida.   (Press enter to continue!)"); getch(); break;
	}
}

void sair()
{
    system("CLS");
    printf("*************************************************");
    printf("\n*                                               *");
    printf("\n*     Obrigado , NewHorizon Market agradece     *");
    printf("\n*         sua presenca, volte sempre.           *");
    printf("\n*                                               *");
    printf("\n*************************************************\n");
    exit(1);
}
